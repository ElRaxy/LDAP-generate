<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>LDAP Tool - AlexMico - Jerarquia Infinita</title>
    <style>
      :root {
        --color-canvas-default: #0d1117;
        --color-canvas-subtle: #161b22;
        --color-border-default: #30363d;
        --color-border-muted: #21262d;
        --color-fg-default: #c9d1d9;
        --color-accent-fg: #58a6ff;
        --color-btn-primary-bg: #238636;
      }
      body {
        font-family: sans-serif;
        background-color: var(--color-canvas-default);
        color: var(--color-fg-default);
        margin: 0;
        padding: 20px;
        display: flex;
        gap: 20px;
        height: 100vh;
        box-sizing: border-box;
      }
      .sidebar {
        width: 420px;
        overflow-y: auto;
        border-right: 1px solid var(--color-border-muted);
        padding-right: 15px;
      }
      .main {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0 20px;
      }
      .card {
        background: var(--color-canvas-subtle);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--color-border-default);
        margin-bottom: 20px;
      }
      h2,
      h3 {
        border-bottom: 1px solid var(--color-border-muted);
        padding-bottom: 5px;
        color: var(--color-accent-fg);
        margin-top: 0;
      }
      label {
        display: block;
        margin: 10px 0 5px;
        font-weight: bold;
        font-size: 12px;
      }
      input,
      textarea,
      select {
        width: 100%;
        background: var(--color-canvas-default);
        border: 1px solid var(--color-border-default);
        color: white;
        padding: 8px;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid var(--color-border-default);
        background: #21262d;
        color: var(--color-accent-fg);
        font-weight: bold;
      }
      button.primary {
        background: var(--color-btn-primary-bg);
        color: white;
        border: none;
        width: 100%;
        padding: 12px;
        margin: 10px 0;
      }
      .ou-row {
        display: flex;
        gap: 5px;
        margin-bottom: 8px;
        background: rgba(255, 255, 255, 0.03);
        padding: 5px;
        border-radius: 4px;
      }
      .tab-nav {
        display: flex;
        gap: 10px;
        border-bottom: 1px solid var(--color-border-muted);
        margin-bottom: 15px;
      }
      .tab-btn {
        padding: 10px;
        cursor: pointer;
        border-radius: 6px 6px 0 0;
      }
      .tab-btn.active {
        background: var(--color-canvas-subtle);
        border: 1px solid var(--color-border-default);
        border-bottom: none;
        color: var(--color-accent-fg);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      textarea.code {
        font-family: monospace;
        font-size: 11px;
        min-height: 200px;
        background: #000;
        color: #79c0ff;
        margin-top: 10px;
      }
      .cmd-box {
        background: #000;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #30363d;
        font-family: monospace;
        font-size: 11px;
        white-space: pre-wrap;
        color: #58a6ff;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="card">
        <h2>CONFIGURACION</h2>
        <label>Dominio</label>
        <input type="text" id="domain" value="amrdaw.local" />
        <label>Password por defecto</label>
        <input type="text" id="plainPass" value="amrdaw" />
        <label>Ruta Trabajo</label>
        <input type="text" id="workPath" value="/tmp/" />
      </div>

      <div class="card">
        <h3>JERARQUIA OUS (SUB-OUS INFINITAS)</h3>
        <p style="font-size: 10px; color: #8b949e; margin-bottom: 10px">
          Ejemplo: Nombre: DAM, Padre: Alumnos (Alumnos debe existir arriba).
        </p>
        <div id="ouContainer">
          <div class="ou-row">
            <input
              type="text"
              class="ou-name"
              placeholder="Nombre"
              value="users"
            />
            <input type="text" class="ou-parent" placeholder="Padre" />
          </div>
          <div class="ou-row">
            <input
              type="text"
              class="ou-name"
              placeholder="Nombre"
              value="groups"
            />
            <input type="text" class="ou-parent" placeholder="Padre" />
          </div>
        </div>
        <button onclick="addOU()">Añadir Unidad / Sub-Unidad</button>
      </div>
    </div>

    <div class="main">
      <div class="tab-nav">
        <div class="tab-btn active" onclick="switchTab(event, 'genTab')">
          Instalacion
        </div>
        <div class="tab-btn" onclick="switchTab(event, 'modTab')">
          Modificaciones
        </div>
      </div>

      <div id="genTab" class="tab-content active">
        <div class="card">
          <label>Nombre Archivo Creacion</label>
          <input type="text" id="fileGen" value="init.ldif" />
          <label>Usuarios (usuario, grupo, OU_final)</label>
          <textarea
            id="csvInput"
            placeholder="pepe, alumnos, DAM"
            style="height: 80px"
          ></textarea>
          <button class="primary" onclick="generateGen()">
            GENERAR CARGA INICIAL
          </button>

          <textarea id="outLdifGen" class="code" readonly></textarea>
          <div class="cmd-box" id="cmd-gen-cat">Sin datos</div>
          <div class="cmd-box" id="cmd-gen-exec">Sin datos</div>
        </div>
      </div>

      <div id="modTab" class="tab-content">
        <div class="card">
          <label>Nombre Archivo Modificacion</label>
          <input type="text" id="fileMod" value="mod.ldif" />
          <label>Tipo de Operacion</label>
          <select id="modType" onchange="updateModFields()">
            <option value="shell">Cambiar Shell</option>
            <option value="mail">Cambiar Email</option>
            <option value="delete">Borrar Usuario</option>
            <option value="group">Añadir a Grupo Extra</option>
          </select>
          <div id="modFields" style="margin-top: 10px"></div>
          <button class="primary" onclick="generateMod()">
            GENERAR MODIFICACION
          </button>

          <textarea id="outLdifMod" class="code" readonly></textarea>
          <div class="cmd-box" id="cmd-mod-cat">Sin datos</div>
          <div class="cmd-box" id="cmd-mod-exec">Sin datos</div>
        </div>
      </div>
    </div>

    <script>
      function addOU() {
        const div = document.createElement('div')
        div.className = 'ou-row'
        div.innerHTML = `<input type="text" class="ou-name" placeholder="Nombre"><input type="text" class="ou-parent" placeholder="Padre"><button onclick="this.parentElement.remove()">X</button>`
        document.getElementById('ouContainer').appendChild(div)
      }

      function switchTab(evt, tabId) {
        document
          .querySelectorAll('.tab-content')
          .forEach(t => t.classList.remove('active'))
        document
          .querySelectorAll('.tab-btn')
          .forEach(b => b.classList.remove('active'))
        document.getElementById(tabId).classList.add('active')
        evt.currentTarget.classList.add('active')
      }

      async function sha1(t) {
        const e = new TextEncoder().encode(t)
        const b = await crypto.subtle.digest('SHA-1', e)
        return `{SHA}${btoa(String.fromCharCode(...new Uint8Array(b)))}`
      }

      function resolveDN(ouName, ouList, baseDn) {
        const ou = ouList.find(o => o.name === ouName)
        if (!ou) return `ou=${ouName},${baseDn}`
        if (!ou.parent) return `ou=${ouName},${baseDn}`
        return `ou=${ouName},${resolveDN(ou.parent, ouList, baseDn)}`
      }

      async function generateGen() {
        const domain = document.getElementById('domain').value
        const baseDn = domain
          .split('.')
          .map(p => `dc=${p}`)
          .join(',')
        const pass = await sha1(document.getElementById('plainPass').value)
        const path =
          document.getElementById('workPath').value +
          document.getElementById('fileGen').value

        const ouRows = document.querySelectorAll('.ou-row')
        let ouList = []
        ouRows.forEach(r => {
          const name = r.querySelector('.ou-name').value.trim()
          const parent = r.querySelector('.ou-parent').value.trim()
          if (name) ouList.push({ name, parent })
        })

        let ldif = '# --- OUs ---\n'
        ouList.forEach(ou => {
          ldif += `dn: ${resolveDN(ou.name, ouList, baseDn)}\nobjectClass: organizationalUnit\nou: ${ou.name}\n\n`
        })

        const raw = document.getElementById('csvInput').value.trim()
        let groups = new Set(),
          gid = 2000,
          uid = 1001,
          gLdif = '# --- GRUPOS ---\n',
          uLdif = '# --- USUARIOS ---\n'

        raw.split('\n').forEach(line => {
          const p = line.split(',').map(s => s.trim())
          if (p.length < 2) return
          const [u, g, targetOu] = p
          const uOuDn = resolveDN(targetOu, ouList, baseDn)
          const gOuDn = ouList.some(o => o.name === 'groups')
            ? resolveDN('groups', ouList, baseDn)
            : uOuDn

          if (!groups.has(g)) {
            groups.add(g)
            gLdif += `dn: cn=${g},${gOuDn}\nobjectClass: posixGroup\ncn: ${g}\ngidNumber: ${gid}\n\n`
            gid++
          }
          uLdif += `dn: uid=${u},${uOuDn}\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\ncn: ${u}\nsn: ${u}\nuid: ${u}\nuidNumber: ${uid}\ngidNumber: ${gid - 1}\nhomeDirectory: /home/${u}\nloginShell: /bin/bash\nuserPassword: ${pass}\n\n`
          uid++
        })

        const final = ldif + gLdif + uLdif
        document.getElementById('outLdifGen').value = final
        document.getElementById('cmd-gen-cat').innerText =
          `cat <<EOF > ${path}\n${final}EOF`
        document.getElementById('cmd-gen-exec').innerText =
          `ldapadd -x -D "cn=admin,${baseDn}" -W -f ${path}`
      }

      function updateModFields() {
        const type = document.getElementById('modType').value
        const container = document.getElementById('modFields')
        container.innerHTML = `<label>UID Usuario</label><input type="text" id="mUid" placeholder="pepe"><label>OU donde está (Nombre)</label><input type="text" id="mOu" placeholder="DAM">`
        if (type !== 'delete')
          container.innerHTML += `<label>Valor / Grupo</label><input type="text" id="mVal">`
      }

      function generateMod() {
        const domain = document.getElementById('domain').value
        const baseDn = domain
          .split('.')
          .map(p => `dc=${p}`)
          .join(',')
        const type = document.getElementById('modType').value
        const uid = document.getElementById('mUid').value
        const ouName = document.getElementById('mOu').value
        const val = document.getElementById('mVal')
          ? document.getElementById('mVal').value
          : ''
        const path =
          document.getElementById('workPath').value +
          document.getElementById('fileMod').value

        // Intentar resolver el DN de la OU desde la lista actual
        const ouRows = document.querySelectorAll('.ou-row')
        let ouList = []
        ouRows.forEach(r => {
          const n = r.querySelector('.ou-name').value.trim()
          const p = r.querySelector('.ou-parent').value.trim()
          if (n) ouList.push({ name: n, parent: p })
        })

        const targetOuDn = resolveDN(ouName, ouList, baseDn)
        const uDn = `uid=${uid},${targetOuDn}`

        let ldif = ''
        if (type === 'shell' || type === 'mail') {
          const attr = type === 'shell' ? 'loginShell' : 'mail'
          ldif = `dn: ${uDn}\nchangetype: modify\nreplace: ${attr}\n${attr}: ${val}`
        } else if (type === 'delete') {
          ldif = `dn: ${uDn}\nchangetype: delete`
        } else if (type === 'group') {
          const gOuDn = ouList.some(o => o.name === 'groups')
            ? resolveDN('groups', ouList, baseDn)
            : targetOuDn
          ldif = `dn: cn=${val},${gOuDn}\nchangetype: modify\nadd: memberUid\nmemberUid: ${uid}`
        }

        document.getElementById('outLdifMod').value = ldif
        document.getElementById('cmd-mod-cat').innerText =
          `cat <<EOF > ${path}\n${ldif}\nEOF`
        document.getElementById('cmd-mod-exec').innerText =
          `ldapmodify -x -D "cn=admin,${baseDn}" -W -f ${path}`
      }
      updateModFields()
    </script>
  </body>
</html>
