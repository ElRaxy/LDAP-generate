<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>LDAP AlexMico</title>
    <style>
      :root {
        --color-canvas-default: #0d1117;
        --color-canvas-subtle: #161b22;
        --color-border-default: #30363d;
        --color-border-muted: #21262d;
        --color-fg-default: #c9d1d9;
        --color-fg-muted: #8b949e;
        --color-accent-fg: #58a6ff;
        --color-btn-primary-bg: #238636;
        --color-btn-primary-hover-bg: #2ea043;
        --color-btn-bg: #21262d;
        --color-btn-hover-bg: #30363d;
        --color-neutral-muted: rgba(110, 118, 129, 0.4);
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica,
          Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        background-color: var(--color-canvas-default);
        color: var(--color-fg-default);
        margin: 0;
        padding: 40px;
        display: flex;
        gap: 32px;
        line-height: 1.5;
        height: 100vh;
        box-sizing: border-box;
      }
      .sidebar {
        width: 300px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        overflow-y: auto;
        padding-right: 16px;
        border-right: 1px solid var(--color-border-muted);
      }
      .main {
        flex-grow: 1;
        max-width: 900px;
        overflow-y: auto;
      }
      .card {
        margin-bottom: 24px;
      }
      h2 {
        font-size: 1.5em;
        font-weight: 600;
        padding-bottom: 0.3em;
        border-bottom: 1px solid var(--color-border-muted);
        margin-top: 24px;
        margin-bottom: 16px;
      }
      h3 {
        font-size: 1.25em;
        font-weight: 600;
        margin-top: 24px;
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-top: 16px;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--color-fg-default);
      }
      input,
      select,
      textarea {
        width: 100%;
        box-sizing: border-box;
        background-color: var(--color-canvas-subtle);
        border: 1px solid var(--color-border-default);
        color: var(--color-fg-default);
        padding: 5px 12px;
        font-size: 14px;
        line-height: 20px;
        border-radius: 6px;
        outline: none;
      }
      input:focus,
      textarea:focus {
        border-color: var(--color-accent-fg);
        box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.3);
      }
      button {
        display: inline-block;
        padding: 5px 16px;
        font-size: 14px;
        font-weight: 500;
        line-height: 20px;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        user-select: none;
        border: 1px solid var(--color-border-default);
        border-radius: 6px;
        appearance: none;
        background-color: var(--color-btn-bg);
        color: var(--color-accent-fg);
        margin-top: 16px;
      }
      button:hover {
        background-color: var(--color-btn-hover-bg);
        border-color: var(--color-fg-muted);
        text-decoration: none;
      }
      button.primary {
        background-color: var(--color-btn-primary-bg);
        color: white;
        border-color: rgba(240, 246, 252, 0.1);
      }
      button.primary:hover {
        background-color: var(--color-btn-primary-hover-bg);
      }
      textarea.code {
        font-family:
          ui-monospace,
          SFMono-Regular,
          SF Mono,
          Menlo,
          Consolas,
          Liberation Mono,
          monospace;
        font-size: 12px;
        padding: 16px;
        background-color: var(--color-canvas-subtle);
        color: #e6edf3;
        min-height: 200px;
        margin-top: 16px;
      }
      .tab-nav {
        display: flex;
        border-bottom: 1px solid var(--color-border-muted);
        margin-bottom: 16px;
      }
      .tab-btn {
        padding: 8px 16px;
        font-size: 14px;
        line-height: 20px;
        color: var(--color-fg-default);
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: 0;
        margin-bottom: -1px;
        border-radius: 6px 6px 0 0;
      }
      .tab-btn.active {
        background-color: var(--color-canvas-default);
        border-color: var(--color-border-muted);
        font-weight: 600;
        border-bottom: 1px solid var(--color-canvas-default);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .cmd-step {
        background-color: var(--color-canvas-subtle);
        border: 1px solid var(--color-border-default);
        border-radius: 6px;
        padding: 16px;
        margin-top: 16px;
      }
      .cmd-text {
        font-family:
          ui-monospace,
          SFMono-Regular,
          SF Mono,
          Menlo,
          Consolas,
          Liberation Mono,
          monospace;
        font-size: 12px;
        color: #79c0ff;
        display: block;
        white-space: pre-wrap;
        word-break: break-all;
        margin-top: 8px;
        padding: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
      }
      .step-title {
        color: var(--color-fg-muted);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="card">
        <h2>Par谩metros Base</h2>
        <label>Dominio</label>
        <input
          type="text"
          id="domain"
          value="amrdaw.local"
          oninput="updateAll()"
        />
        <label>Password Usuarios</label>
        <input
          type="text"
          id="plainPass"
          value="amrdaw"
          oninput="updateAll()"
        />

        <label> Ruta Trabajo</label>
        <input
          type="text"
          id="workPath"
          value="/tmp/"
          placeholder="/home/usuario/"
          oninput="updateAll()"
        />
      </div>

      <div class="card">
        <h3>Archivos</h3>
        <label>Archivo Creaci贸n (.ldif)</label>
        <input
          type="text"
          id="fileGen"
          value="init.ldif"
          placeholder="init.ldif"
          oninput="updateAll()"
        />
        <label>Archivo Modificaci贸n (.ldif)</label>
        <input
          type="text"
          id="fileMod"
          value="mod.ldif"
          placeholder="mod.ldif"
          oninput="updateAll()"
        />
      </div>

      <div class="card">
        <h3>Estructura OUs</h3>
        <label>OU Usuarios</label>
        <input
          type="text"
          id="ouUsers"
          value="ou=users"
          oninput="updateAll()"
        />
        <label>OU Grupos</label>
        <input
          type="text"
          id="ouGroups"
          value="ou=groups"
          oninput="updateAll()"
        />
      </div>
    </div>

    <div class="main">
      <div class="tab-nav">
        <div id="btn-gen" class="tab-btn active" onclick="openTab('gen')">
          Instalaci贸n
        </div>
        <div id="btn-mods" class="tab-btn" onclick="openTab('mods')">
          Modificaciones
        </div>
      </div>

      <div id="gen" class="tab-content active card">
        <h3>Crear Usuarios y Grupos</h3>
        <textarea
          id="csvInput"
          style="height: 100px"
          oninput="updateAll()"
          placeholder="usuario, grupo"
        ></textarea>
        <button class="primary" onclick="generateAll()">Generar LDIF</button>

        <textarea id="outputLdif" class="code"></textarea>

        <div class="cmd-step">
          <span class="step-title">Terminal: Crear archivo</span>
          <code class="cmd-text" id="step1-gen"
            >Genera para ver el comando...</code
          >
        </div>
        <div class="cmd-step">
          <span class="step-title">Terminal: Ejecutar</span>
          <code class="cmd-text" id="step2-gen"
            >Genera para ver el comando...</code
          >
        </div>
      </div>

      <div id="mods" class="tab-content card">
        <h3> Modificaciones R谩pidas</h3>
        <select id="modType" onchange="updateModFields()">
          <option value="shell">Cambiar Shell</option>
          <option value="mail">Cambiar Email</option>
          <option value="delete">Borrar Usuario</option>
          <option value="addgroup">A帽adir a Grupo Extra</option>
        </select>
        <div id="modFields"></div>
        <button class="primary" onclick="generateMod()">
          Generar Modificaci贸n
        </button>

        <textarea id="outputMod" class="code"></textarea>

        <div class="cmd-step">
          <span class="step-title">Terminal: Crear archivo</span>
          <code class="cmd-text" id="step1-mod"
            >Genera para ver el comando...</code
          >
        </div>
        <div class="cmd-step">
          <span class="step-title">Terminal: Ejecutar</span>
          <code class="cmd-text" id="step2-mod"
            >Genera para ver el comando...</code
          >
        </div>
      </div>
    </div>

    <script>
      async function sha1Hash(text) {
        const encoder = new TextEncoder();
        const data = encoder.encode(text);
        const hashBuffer = await crypto.subtle.digest("SHA-1", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const base64Hash = btoa(String.fromCharCode(...hashArray));
        return `{SHA}${base64Hash}`;
      }

      function getBaseDn() {
        return document
          .getElementById("domain")
          .value.split(".")
          .map((p) => `dc=${p}`)
          .join(",");
      }

      function getFilePath(id) {
        let path = document.getElementById("workPath").value.trim();
        let name =
          document.getElementById(id).value.trim() ||
          document.getElementById(id).placeholder;
        if (path !== "" && !path.endsWith("/")) path += "/";
        return path + name;
      }

      function openTab(id) {
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        document.getElementById("btn-" + id).classList.add("active");
      }

      function updateAll() {
        /* Refresco din谩mico opcional */
      }

      async function generateAll() {
        const baseDn = getBaseDn();
        const path = getFilePath("fileGen");
        const ouU = document.getElementById("ouUsers").value.trim();
        const ouG = document.getElementById("ouGroups").value.trim();
        const passHash = await sha1Hash(
          document.getElementById("plainPass").value,
        );
        const raw = document.getElementById("csvInput").value;

        const suffixU = ouU ? `${ouU},${baseDn}` : baseDn;
        const suffixG = ouG ? `${ouG},${baseDn}` : baseDn;

        let ldif = `# --- LDAP INIT ---\n`;
        function createOu(p, b) {
          if (!p) return "";
          let current = b,
            res = "";
          p.split(",")
            .reverse()
            .forEach((part) => {
              current = part + "," + current;
              res += `dn: ${current}\nobjectClass: organizationalUnit\nou: ${part.split("=")[1]}\n\n`;
            });
          return res;
        }

        ldif += createOu(ouU, baseDn);
        if (ouG && ouG !== ouU) ldif += createOu(ouG, baseDn);

        let groups = new Set(),
          gMap = {},
          gid = 2000,
          uid = 1001;
        let groupPart = "",
          userPart = "";

        raw.split("\n").forEach((line) => {
          if (!line.includes(",")) return;
          let [u, g] = line.split(",").map((s) => s.trim());
          if (!groups.has(g)) {
            groups.add(g);
            gMap[g] = gid;
            groupPart += `dn: cn=${g},${suffixG}\nobjectClass: posixGroup\ncn: ${g}\ngidNumber: ${gid}\n\n`;
            gid++;
          }
          userPart += `dn: uid=${u},${suffixU}\nobjectClass: inetOrgPerson\nobjectClass: posixAccount\ncn: ${u}\nsn: ${u}\nuid: ${u}\nuidNumber: ${uid}\ngidNumber: ${gMap[g]}\nhomeDirectory: /home/${u}\nloginShell: /bin/bash\nuserPassword: ${passHash}\n\n`;
          uid++;
        });

        const finalLdif = ldif + groupPart + userPart;
        document.getElementById("outputLdif").value = finalLdif;
        document.getElementById("step1-gen").innerText =
          `cat <<EOF > ${path}\n${finalLdif}EOF`;
        document.getElementById("step2-gen").innerText =
          `ldapadd -x -D "cn=admin,${baseDn}" -W -f ${path}`;
      }

      function updateModFields() {
        const type = document.getElementById("modType").value;
        const container = document.getElementById("modFields");
        let html = `<label>UID Usuario</label><input type="text" id="mUid" placeholder="uid_usuario" oninput="generateMod()">`;
        if (type === "shell")
          html += `<label>Nuevo Shell</label><input type="text" id="mVal" value="/bin/false" oninput="generateMod()">`;
        if (type === "mail")
          html += `<label>Nuevo Mail</label><input type="text" id="mVal" value="user@mail.com" oninput="generateMod()">`;
        if (type === "addgroup")
          html += `<label>Grupo Extra</label><input type="text" id="mVal" value="admins" oninput="generateMod()">`;
        container.innerHTML = html;
      }

      function generateMod() {
        const baseDn = getBaseDn();
        const path = getFilePath("fileMod");
        const ouU = document.getElementById("ouUsers").value.trim();
        const ouG = document.getElementById("ouGroups").value.trim();
        const suffixU = ouU ? `${ouU},${baseDn}` : baseDn;
        const suffixG = ouG ? `${ouG},${baseDn}` : baseDn;
        const type = document.getElementById("modType").value;
        const uid = document.getElementById("mUid").value;
        const val = document.getElementById("mVal")
          ? document.getElementById("mVal").value
          : "";

        let ldif = "";
        if (type === "shell" || type === "mail") {
          let attr = type === "shell" ? "loginShell" : "mail";
          ldif = `dn: uid=${uid},${suffixU}\nchangetype: modify\nreplace: ${attr}\n${attr}: ${val}`;
        } else if (type === "delete") {
          ldif = `dn: uid=${uid},${suffixU}\nchangetype: delete`;
        } else if (type === "addgroup") {
          ldif = `dn: cn=${val},${suffixG}\nchangetype: modify\nadd: memberUid\nmemberUid: ${uid}`;
        }

        document.getElementById("outputMod").value = ldif;
        document.getElementById("step1-mod").innerText =
          `cat <<EOF > ${path}\n${ldif}\nEOF`;
        document.getElementById("step2-mod").innerText =
          `ldapmodify -x -D "cn=admin,${baseDn}" -W -f ${path}`;
      }

      updateModFields();
    </script>
  </body>
</html>
